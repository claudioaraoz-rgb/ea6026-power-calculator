<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EA-6026-X PDU Power Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border-radius: 8px;
        }
        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .input-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 4px;
            font-size: 16px;
        }
        .input-group input:focus {
            border-color: #007bff;
            outline: none;
        }
        .rules-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 30px;
        }
        .rules-section h3 {
            color: #856404;
            margin-top: 0;
        }
        .rule-status {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        .rule-status.ok {
            background: #d4edda;
            color: #155724;
        }
        .rule-status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .outlets-section {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin-bottom: 30px;
        }
        .outlets-table {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }
        .outlets-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .outlets-table th {
            background: #495057;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-size: 12px;
        }
        .outlets-table td {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            font-size: 12px;
        }
        .outlets-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .circuit-section {
            background: #e3f2fd;
            padding: 6px;
            font-weight: bold;
        }
        .power-input {
            width: 60px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
        }
        .calculations-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }
        .calculation-group {
            margin-bottom: 20px;
        }
        .calculation-group h4 {
            margin: 0 0 10px 0;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .calc-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .calc-row:last-child {
            border-bottom: none;
        }
        .calc-value {
            font-weight: bold;
        }
        .phase-l1 { background-color: #fff3e0; }
        .phase-l2 { background-color: #e8f5e8; }
        .phase-l3 { background-color: #f3e5f5; }
        .summary-section {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }
        .summary-section h3 {
            color: #004085;
            margin-top: 0;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .summary-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #b8daff;
        }
        .summary-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .summary-item .label {
            font-size: 12px;
            color: #666;
        }
        
        /* Responsive design for input section */
        @media (max-width: 768px) {
            .input-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .outlets-section {
                grid-template-columns: 1fr;
            }
        }
        
        /* Export button styling */
        .export-button, .import-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }
        
        .export-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .import-button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        
        .export-button:hover {
            background: linear-gradient(135deg, #218838, #1ea67a);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .import-button:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .export-button:active, .import-button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>30A 120/208V 3 PHASE</h1>
            <h2 id="pdu-title">EA-6026-X</h2>
            <p>eConnect Vertical PDU Power Calculator</p>
            <p style="font-size: 14px; margin: 10px 0 0 0;">Fill out this form to calculate power distribution and verify load balancing</p>
        </div>

        <div class="input-section">
            <div class="input-group">
                <label for="rackName">Rack Name/ID</label>
                <input type="text" id="rackName" placeholder="e.g. Rack A1, Server-01, etc." maxlength="50">
                <small>Identify which rack this PDU serves</small>
            </div>
            <div class="input-group">
                <label for="voltage">Input Voltage (V)</label>
                <input type="number" id="voltage" value="208" step="1" min="208" max="240">
                <small>208V typical, 240V max</small>
            </div>
            <div class="input-group">
                <label for="powerFactor">Power Factor (%)</label>
                <input type="number" id="powerFactor" value="90" step="0.1" min="70" max="100">
                <small>90% typical</small>
            </div>
        </div>

        <div class="rules-section">
            <h3>Safety Rules for EA-6026-X</h3>
            <div class="rule-status ok" id="rule-c13">
                <span>No C13 outlet to exceed 12A</span>
                <span id="rule-c13-status">OK</span>
            </div>
            <div class="rule-status ok" id="rule-c19">
                <span>No C19 outlet to exceed 16A</span>
                <span id="rule-c19-status">OK</span>
            </div>
            <div class="rule-status ok" id="rule-5-20r">
                <span>No 5-20R outlet to exceed 20A</span>
                <span id="rule-5-20r-status">OK</span>
            </div>
            <div class="rule-status ok" id="rule-cb">
                <span>No circuit breaker to exceed 20A</span>
                <span id="rule-cb-status">OK</span>
            </div>
            <div class="rule-status ok" id="rule-line">
                <span>No line input to exceed 24A (NEC derated)</span>
                <span id="rule-line-status">OK</span>
            </div>
        </div>

        <div class="outlets-section">
            <div class="outlets-table">
                <table>
                    <thead>
                        <tr>
                            <th>Outlet#</th>
                            <th>Circuit</th>
                            <th>Phase</th>
                            <th>Type</th>
                            <th>Device</th>
                            <th>Watts</th>
                            <th>Amps</th>
                        </tr>
                    </thead>
                    <tbody id="outlets-tbody">
                        <!-- Outlets will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="calculations-panel">
                <div class="calculation-group">
                    <h4>Circuit Breaker Current</h4>
                    <div class="calc-row">
                        <span>CB1 (L1/L2):</span>
                        <span class="calc-value" id="cb1-current">0.0A</span>
                    </div>
                    <div class="calc-row">
                        <span>CB2 (L2/L3):</span>
                        <span class="calc-value" id="cb2-current">0.0A</span>
                    </div>
                    <div class="calc-row">
                        <span>CB3 (L3/L1):</span>
                        <span class="calc-value" id="cb3-current">0.0A</span>
                    </div>
                </div>

                <div class="calculation-group">
                    <h4>Line Current</h4>
                    <div class="calc-row">
                        <span>L1:</span>
                        <span class="calc-value" id="line-l1">0.0A</span>
                    </div>
                    <div class="calc-row">
                        <span>L2:</span>
                        <span class="calc-value" id="line-l2">0.0A</span>
                    </div>
                    <div class="calc-row">
                        <span>L3:</span>
                        <span class="calc-value" id="line-l3">0.0A</span>
                    </div>
                </div>

                <div class="calculation-group">
                    <h4>Remaining Capacity</h4>
                    <div class="calc-row">
                        <span>L1:</span>
                        <span class="calc-value" id="remain-l1">100%</span>
                    </div>
                    <div class="calc-row">
                        <span>L2:</span>
                        <span class="calc-value" id="remain-l2">100%</span>
                    </div>
                    <div class="calc-row">
                        <span>L3:</span>
                        <span class="calc-value" id="remain-l3">100%</span>
                    </div>
                </div>

                <div class="calculation-group">
                    <h4>Total Power</h4>
                    <div class="calc-row">
                        <span>Apparent Power:</span>
                        <span class="calc-value" id="apparent-power">0.00 kVA</span>
                    </div>
                    <div class="calc-row">
                        <span>Real Power:</span>
                        <span class="calc-value" id="real-power">0.00 kW</span>
                    </div>
                </div>

                <div class="calculation-group">
                    <h4>Overall Status</h4>
                    <div class="calc-row">
                        <span>System Status:</span>
                        <span class="calc-value" id="overall-status" style="color: green;">OK</span>
                    </div>
                </div>

                <div class="calculation-group">
                    <h4>Data Management</h4>
                    <input type="file" id="import-file" accept=".csv" style="display: none;">
                    <button id="import-btn" class="import-button">Import from CSV</button>
                    <button id="export-btn" class="export-button">Export to CSV</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // EA-6026-X outlet configuration based on the actual wiring schematic
        const outletConfig = [
            // CB1 (L1/L2) - 20A breaker
            {outlet: 1, phase: 'L1/L2', type: 'C13', circuit: 'CB1'},
            {outlet: 4, phase: 'L1/L2', type: 'C13', circuit: 'CB1'},
            {outlet: 7, phase: 'L1/L2', type: 'C19', circuit: 'CB1'},
            {outlet: 10, phase: 'L1/L2', type: 'C13', circuit: 'CB1'},
            {outlet: 13, phase: 'L1/L2', type: 'C13', circuit: 'CB1'},
            {outlet: 16, phase: 'L1/L2', type: 'C13', circuit: 'CB1'},
            {outlet: 19, phase: 'L1/L2', type: 'C13', circuit: 'CB1'},
            {outlet: 22, phase: 'L1/L2', type: 'C19', circuit: 'CB1'},
            {outlet: 25, phase: 'L1/N', type: '5-20R', circuit: 'AUX1'},
            
            // CB2 (L2/L3) - 20A breaker
            {outlet: 2, phase: 'L2/L3', type: 'C13', circuit: 'CB2'},
            {outlet: 5, phase: 'L2/L3', type: 'C13', circuit: 'CB2'},
            {outlet: 8, phase: 'L2/L3', type: 'C19', circuit: 'CB2'},
            {outlet: 11, phase: 'L2/L3', type: 'C19', circuit: 'CB2'},
            {outlet: 14, phase: 'L2/L3', type: 'C13', circuit: 'CB2'},
            {outlet: 17, phase: 'L2/L3', type: 'C13', circuit: 'CB2'},
            {outlet: 20, phase: 'L2/L3', type: 'C13', circuit: 'CB2'},
            {outlet: 23, phase: 'L2/L3', type: 'C13', circuit: 'CB2'},
            {outlet: 26, phase: 'L2/N', type: '5-20R', circuit: 'AUX2'},
            
            // CB3 (L3/L1) - 20A breaker
            {outlet: 3, phase: 'L3/L1', type: 'C13', circuit: 'CB3'},
            {outlet: 6, phase: 'L3/L1', type: 'C13', circuit: 'CB3'},
            {outlet: 9, phase: 'L3/L1', type: 'C13', circuit: 'CB3'},
            {outlet: 12, phase: 'L3/L1', type: 'C19', circuit: 'CB3'},
            {outlet: 15, phase: 'L3/L1', type: 'C13', circuit: 'CB3'},
            {outlet: 18, phase: 'L3/L1', type: 'C13', circuit: 'CB3'},
            {outlet: 21, phase: 'L3/L1', type: 'C19', circuit: 'CB3'},
            {outlet: 24, phase: 'L3/L1', type: 'C13', circuit: 'CB3'},
            {outlet: 27, phase: 'L3/N', type: '5-20R', circuit: 'AUX3'}
        ];

        // Initialize the calculator
        function initializeCalculator() {
            const tbody = document.getElementById('outlets-tbody');
            tbody.innerHTML = '';
            
            // Sort outlets by outlet number for better display
            const sortedConfig = [...outletConfig].sort((a, b) => {
                const aNum = parseInt(a.outlet);
                const bNum = parseInt(b.outlet);
                return aNum - bNum;
            });
            
            sortedConfig.forEach((config, index) => {
                const row = document.createElement('tr');
                const phaseClass = config.phase.includes('L1') && config.phase.includes('L2') ? 'phase-l1' :
                                 config.phase.includes('L2') && config.phase.includes('L3') ? 'phase-l2' : 
                                 config.phase.includes('L3') && config.phase.includes('L1') ? 'phase-l3' :
                                 config.phase.includes('L1') ? 'phase-l1' :
                                 config.phase.includes('L2') ? 'phase-l2' : 'phase-l3';
                row.className = phaseClass;
                
                // Find original index for data binding
                const originalIndex = outletConfig.findIndex(orig => orig.outlet === config.outlet);
                
                row.innerHTML = `
                    <td><strong>${config.outlet}</strong></td>
                    <td>${config.circuit}</td>
                    <td>${config.phase}</td>
                    <td>${config.type}</td>
                    <td><input type="text" class="power-input device-input" data-outlet="${originalIndex}" placeholder="Device" style="width: 80px;"></td>
                    <td><input type="number" class="power-input watts-input" data-outlet="${originalIndex}" min="0" step="1" value="0" placeholder="0"></td>
                    <td class="amps-display">0.0</td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.watts-input, #voltage, #powerFactor').forEach(input => {
                input.addEventListener('input', calculateAll);
            });
            
            // Add rack name update functionality
            document.getElementById('rackName').addEventListener('input', updateRackName);
            
            // Add export functionality
            document.getElementById('export-btn').addEventListener('click', exportToCSV);
            
            // Add import functionality
            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('import-file').click();
            });
            
            document.getElementById('import-file').addEventListener('change', handleImport);
            
            calculateAll();
        }

        function calculateAll() {
            const voltage = parseFloat(document.getElementById('voltage').value) || 208;
            const powerFactor = parseFloat(document.getElementById('powerFactor').value) / 100 || 0.9;
            
            let totalWatts = 0;
            let lineCurrents = {L1: 0, L2: 0, L3: 0};
            let circuitCurrents = {CB1: 0, CB2: 0, CB3: 0};
            let maxOutletCurrents = {C13: 0, C19: 0, '5-20R': 0};
            
            // Calculate current for each outlet
            document.querySelectorAll('.watts-input').forEach(input => {
                const outletIndex = parseInt(input.dataset.outlet);
                const watts = parseFloat(input.value) || 0;
                const config = outletConfig[outletIndex];
                
                // Calculate current based on outlet type
                let current = 0;
                if (config.type === '5-20R') {
                    // 5-20R outlets are line-to-neutral (120V)
                    current = watts / (120 * powerFactor);
                } else {
                    // C13 and C19 are line-to-line (208V)
                    current = watts / (voltage * powerFactor);
                }
                
                // Update display
                const ampsDisplay = input.closest('tr').querySelector('.amps-display');
                ampsDisplay.textContent = current.toFixed(1);
                
                // Track maximum current by outlet type
                maxOutletCurrents[config.type] = Math.max(maxOutletCurrents[config.type], current);
                
                // Add to circuit breaker currents
                if (config.circuit === 'CB1' || config.circuit === 'CB2' || config.circuit === 'CB3') {
                    circuitCurrents[config.circuit] += current;
                }
                
                // Calculate line currents using proper 3-phase math
                const phase = config.phase;
                if (phase === 'L1/L2') {
                    // 120° apart, so each line carries the current with 30° phase shift
                    lineCurrents.L1 += current * 0.866;  // cos(30°)
                    lineCurrents.L2 += current * 0.866;
                } else if (phase === 'L2/L3') {
                    lineCurrents.L2 += current * 0.866;
                    lineCurrents.L3 += current * 0.866;
                } else if (phase === 'L3/L1') {
                    lineCurrents.L3 += current * 0.866;
                    lineCurrents.L1 += current * 0.866;
                } else if (phase.includes('/N')) {
                    // Line-to-neutral loads (convenience outlets)
                    if (phase === 'L1/N') lineCurrents.L1 += current;
                    if (phase === 'L2/N') lineCurrents.L2 += current;
                    if (phase === 'L3/N') lineCurrents.L3 += current;
                }
                
                totalWatts += watts;
            });
            
            // Update circuit breaker displays
            document.getElementById('cb1-current').textContent = circuitCurrents.CB1.toFixed(1) + 'A';
            document.getElementById('cb2-current').textContent = circuitCurrents.CB2.toFixed(1) + 'A';
            document.getElementById('cb3-current').textContent = circuitCurrents.CB3.toFixed(1) + 'A';
            
            // Update line current displays
            document.getElementById('line-l1').textContent = lineCurrents.L1.toFixed(1) + 'A';
            document.getElementById('line-l2').textContent = lineCurrents.L2.toFixed(1) + 'A';
            document.getElementById('line-l3').textContent = lineCurrents.L3.toFixed(1) + 'A';
            
            // Calculate remaining capacity
            const maxLineCurrent = 24; // NEC derated 30A to 24A
            document.getElementById('remain-l1').textContent = Math.max(0, ((maxLineCurrent - lineCurrents.L1) / maxLineCurrent * 100)).toFixed(0) + '%';
            document.getElementById('remain-l2').textContent = Math.max(0, ((maxLineCurrent - lineCurrents.L2) / maxLineCurrent * 100)).toFixed(0) + '%';
            document.getElementById('remain-l3').textContent = Math.max(0, ((maxLineCurrent - lineCurrents.L3) / maxLineCurrent * 100)).toFixed(0) + '%';
            
            // Calculate total power
            const apparentPower = totalWatts / (powerFactor * 1000);
            const realPower = totalWatts / 1000;
            
            document.getElementById('apparent-power').textContent = apparentPower.toFixed(2) + ' kVA';
            document.getElementById('real-power').textContent = realPower.toFixed(2) + ' kW';
            
            // Check safety rules
            const maxCBCurrent = Math.max(circuitCurrents.CB1, circuitCurrents.CB2, circuitCurrents.CB3);
            checkSafetyRules(maxOutletCurrents, Math.max(lineCurrents.L1, lineCurrents.L2, lineCurrents.L3), maxCBCurrent);
        }

        function checkSafetyRules(maxOutletCurrents, maxLineCurrent, maxCBCurrent) {
            const rules = [
                {id: 'rule-c13', condition: maxOutletCurrents.C13 <= 12, limit: 12, current: maxOutletCurrents.C13},
                {id: 'rule-c19', condition: maxOutletCurrents.C19 <= 16, limit: 16, current: maxOutletCurrents.C19},
                {id: 'rule-5-20r', condition: maxOutletCurrents['5-20R'] <= 20, limit: 20, current: maxOutletCurrents['5-20R']},
                {id: 'rule-cb', condition: maxCBCurrent <= 20, limit: 20, current: maxCBCurrent},
                {id: 'rule-line', condition: maxLineCurrent <= 24, limit: 24, current: maxLineCurrent}
            ];
            
            let allOk = true;
            
            rules.forEach(rule => {
                const element = document.getElementById(rule.id);
                const statusElement = document.getElementById(rule.id + '-status');
                
                if (rule.condition) {
                    element.className = 'rule-status ok';
                    statusElement.textContent = 'OK';
                } else {
                    element.className = 'rule-status error';
                    statusElement.textContent = `ERROR (${rule.current.toFixed(1)}A > ${rule.limit}A)`;
                    allOk = false;
                }
            });
            
            // Update overall status
            const overallStatus = document.getElementById('overall-status');
            if (allOk) {
                overallStatus.textContent = 'OK';
                overallStatus.style.color = 'green';
            } else {
                overallStatus.textContent = 'ERROR';
                overallStatus.style.color = 'red';
            }
        }

        function updateRackName() {
            const rackName = document.getElementById('rackName').value.trim();
            const titleElement = document.getElementById('pdu-title');
            
            if (rackName) {
                titleElement.textContent = `EA-6026-X - ${rackName}`;
            } else {
                titleElement.textContent = 'EA-6026-X';
            }
        }

        function exportToCSV() {
            const rackName = document.getElementById('rackName').value.trim() || 'Unnamed Rack';
            const voltage = document.getElementById('voltage').value;
            const powerFactor = document.getElementById('powerFactor').value;
            const timestamp = new Date().toLocaleString();
            
            // Get current calculations
            const lineL1 = document.getElementById('line-l1').textContent;
            const lineL2 = document.getElementById('line-l2').textContent;
            const lineL3 = document.getElementById('line-l3').textContent;
            const cb1Current = document.getElementById('cb1-current').textContent;
            const cb2Current = document.getElementById('cb2-current').textContent;
            const cb3Current = document.getElementById('cb3-current').textContent;
            const remainL1 = document.getElementById('remain-l1').textContent;
            const remainL2 = document.getElementById('remain-l2').textContent;
            const remainL3 = document.getElementById('remain-l3').textContent;
            const apparentPower = document.getElementById('apparent-power').textContent;
            const realPower = document.getElementById('real-power').textContent;
            const overallStatus = document.getElementById('overall-status').textContent;
            
            // Create CSV content
            let csvContent = '';
            
            // Header information
            csvContent += 'EA-6026-X PDU Power Calculation Report\n';
            csvContent += `Generated: ${timestamp}\n`;
            csvContent += `Rack Name: ${rackName}\n`;
            csvContent += `PDU Model: EA-6026-X\n`;
            csvContent += `Input Voltage: ${voltage}V\n`;
            csvContent += `Power Factor: ${powerFactor}%\n`;
            csvContent += `Overall Status: ${overallStatus}\n`;
            csvContent += '\n';
            
            // Summary section
            csvContent += 'POWER SUMMARY\n';
            csvContent += 'Parameter,Value\n';
            csvContent += `CB1 Current (L1/L2),${cb1Current}\n`;
            csvContent += `CB2 Current (L2/L3),${cb2Current}\n`;
            csvContent += `CB3 Current (L3/L1),${cb3Current}\n`;
            csvContent += `Line L1 Current,${lineL1}\n`;
            csvContent += `Line L2 Current,${lineL2}\n`;
            csvContent += `Line L3 Current,${lineL3}\n`;
            csvContent += `L1 Remaining Capacity,${remainL1}\n`;
            csvContent += `L2 Remaining Capacity,${remainL2}\n`;
            csvContent += `L3 Remaining Capacity,${remainL3}\n`;
            csvContent += `Total Apparent Power,${apparentPower}\n`;
            csvContent += `Total Real Power,${realPower}\n`;
            csvContent += '\n';
            
            // Safety rules status
            csvContent += 'SAFETY RULES STATUS\n';
            csvContent += 'Rule,Status\n';
            csvContent += `C13 outlets ≤ 12A,${document.getElementById('rule-c13-status').textContent}\n`;
            csvContent += `C19 outlets ≤ 16A,${document.getElementById('rule-c19-status').textContent}\n`;
            csvContent += `5-20R outlets ≤ 20A,${document.getElementById('rule-5-20r-status').textContent}\n`;
            csvContent += `Circuit breakers ≤ 20A,${document.getElementById('rule-cb-status').textContent}\n`;
            csvContent += `Line current ≤ 24A,${document.getElementById('rule-line-status').textContent}\n`;
            csvContent += '\n';
            
            // Outlet details
            csvContent += 'OUTLET CONFIGURATION\n';
            csvContent += 'Outlet,Circuit,Phase,Type,Device,Watts,Amps\n';
            
            const outletRows = document.querySelectorAll('#outlets-tbody tr');
            outletRows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                const outlet = cells[0].textContent;
                const circuit = cells[1].textContent;
                const phase = cells[2].textContent;
                const type = cells[3].textContent;
                const device = cells[4].querySelector('input').value || '';
                const watts = cells[5].querySelector('input').value || '0';
                const amps = cells[6].textContent;
                
                // Escape commas in device names
                const escapedDevice = device.includes(',') ? `"${device}"` : device;
                csvContent += `${outlet},${circuit},${phase},${type},${escapedDevice},${watts},${amps}\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, `${rackName.replace(/[^a-zA-Z0-9-_]/g, '_')}_EA6026_PowerCalc.csv`);
            } else {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${rackName.replace(/[^a-zA-Z0-9-_]/g, '_')}_EA6026_PowerCalc.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSVAndPopulate(e.target.result);
                } catch (error) {
                    alert('Error reading file: ' + error.message + '\n\nPlease make sure you\'re importing a CSV file that was exported from this calculator.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        function parseCSVAndPopulate(csvContent) {
            const lines = csvContent.split('\n');
            let currentSection = '';
            let outletData = [];
            let rackName = '';
            let voltage = 208;
            let powerFactor = 90;
            
            // Parse the CSV content
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Extract header information
                if (line.startsWith('Rack Name:')) {
                    rackName = line.split(':')[1].trim();
                }
                if (line.startsWith('Input Voltage:')) {
                    voltage = parseInt(line.split(':')[1].replace('V', '').trim()) || 208;
                }
                if (line.startsWith('Power Factor:')) {
                    powerFactor = parseFloat(line.split(':')[1].replace('%', '').trim()) || 90;
                }
                
                // Find outlet configuration section
                if (line === 'OUTLET CONFIGURATION') {
                    currentSection = 'outlets';
                    continue;
                }
                
                // Skip header row of outlet section
                if (currentSection === 'outlets' && line.startsWith('Outlet,Circuit,Phase')) {
                    continue;
                }
                
                // Parse outlet data
                if (currentSection === 'outlets' && line.includes(',')) {
                    const parts = parseCSVLine(line);
                    if (parts.length >= 7) {
                        outletData.push({
                            outlet: parts[0],
                            circuit: parts[1],
                            phase: parts[2],
                            type: parts[3],
                            device: parts[4].replace(/"/g, ''), // Remove quotes
                            watts: parseInt(parts[5]) || 0,
                            amps: parts[6]
                        });
                    }
                }
            }
            
            // Populate the form
            populateForm(rackName, voltage, powerFactor, outletData);
            
            // Show success message
            alert(`Successfully imported configuration for: ${rackName || 'Unnamed Rack'}\n\n` +
                  `Loaded ${outletData.length} outlet configurations.\n` +
                  `Settings: ${voltage}V, ${powerFactor}% power factor`);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function populateForm(rackName, voltage, powerFactor, outletData) {
            // Set basic parameters
            if (rackName) {
                document.getElementById('rackName').value = rackName;
                updateRackName();
            }
            document.getElementById('voltage').value = voltage;
            document.getElementById('powerFactor').value = powerFactor;
            
            // Clear all outlet inputs first
            document.querySelectorAll('.watts-input, .device-input').forEach(input => {
                if (input.classList.contains('watts-input')) {
                    input.value = 0;
                } else {
                    input.value = '';
                }
            });
            
            // Populate outlet data
            outletData.forEach(data => {
                // Find the corresponding input field for this outlet
                const outletIndex = outletConfig.findIndex(config => 
                    config.outlet.toString() === data.outlet.toString()
                );
                
                if (outletIndex !== -1) {
                    const wattsInput = document.querySelector(`.watts-input[data-outlet="${outletIndex}"]`);
                    const deviceInput = document.querySelector(`.device-input[data-outlet="${outletIndex}"]`);
                    
                    if (wattsInput) wattsInput.value = data.watts;
                    if (deviceInput) deviceInput.value = data.device;
                }
            });
            
            // Recalculate everything
            calculateAll();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeCalculator);
    </script>
</body>
</html>
